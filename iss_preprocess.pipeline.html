<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" />

    <!-- Generated with Sphinx 6.1.3 and Furo 2022.12.07 -->
        <title>iss_preprocess.pipeline package - iss-preprocess 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=91d0f0d1c444bdcb17a68e833c7a53903343c195" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">iss-preprocess 0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">iss-preprocess 0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  
</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="iss-preprocess-pipeline-package">
<h1>iss_preprocess.pipeline package<a class="headerlink" href="#iss-preprocess-pipeline-package" title="Permalink to this heading">#</a></h1>
<section id="submodules">
<h2>Submodules<a class="headerlink" href="#submodules" title="Permalink to this heading">#</a></h2>
</section>
<section id="module-iss_preprocess.pipeline.ara_registration">
<span id="iss-preprocess-pipeline-ara-registration-module"></span><h2>iss_preprocess.pipeline.ara_registration module<a class="headerlink" href="#module-iss_preprocess.pipeline.ara_registration" title="Permalink to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.ara_registration.find_roi_position_on_cryostat">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.ara_registration.</span></span><span class="sig-name descname"><span class="pre">find_roi_position_on_cryostat</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.ara_registration.find_roi_position_on_cryostat" title="Permalink to this definition">#</a></dt>
<dd><p>Find the A/P position of each ROI relative to the first collected slice</p>
<p>The section order is guess from the sign of <cite>section_thickness_um</cite>, positive for
antero-posterior slicing (starting from the olfactory bulb), negative for opposite.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>data_path</strong> (<em>str</em>) – Relative path to the data</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>For each ROI, the slice depth in um relative to the</dt><dd><p>first collected slice</p>
</dd>
</dl>
<p>min_step (float): Minimum thickness between two slices</p>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>roi_slice_pos_um (dict)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.ara_registration.load_coordinate_image">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.ara_registration.</span></span><span class="sig-name descname"><span class="pre">load_coordinate_image</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">full_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.ara_registration.load_coordinate_image" title="Permalink to this definition">#</a></dt>
<dd><p>Load the 3 channel image of ARA coordinates for <cite>roi</cite></p>
<p>TODO: should it go in io?</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data</p></li>
<li><p><strong>roi</strong> (<em>int</em>) – Number of the ROI</p></li>
<li><p><strong>full_scale</strong> (<em>bool</em><em>, </em><em>optional</em>) – If true, returns the full scale image, otherwise
the downsample version used for registration. Defaults to False.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.ara_registration.load_registration_reference_metadata">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.ara_registration.</span></span><span class="sig-name descname"><span class="pre">load_registration_reference_metadata</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.ara_registration.load_registration_reference_metadata" title="Permalink to this definition">#</a></dt>
<dd><p>Load metadata file associated with registration reference of one ROI</p>
<p>This is the “registration_reference_r{roi}_sl{slice_number}.yml” file that contains
shape and downsampling info.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data</p></li>
<li><p><strong>roi</strong> (<em>int</em>) – Number of the roi</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Content of the metadata yml file</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>metadata (dict)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.ara_registration.make_area_image">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.ara_registration.</span></span><span class="sig-name descname"><span class="pre">make_area_image</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atlas_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">full_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.ara_registration.make_area_image" title="Permalink to this definition">#</a></dt>
<dd><p>Generate an image with area ID in each pixel</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data</p></li>
<li><p><strong>roi</strong> (<em>int</em>) – Roi number to generate</p></li>
<li><p><strong>atlas_size</strong> (<em>int</em><em>, </em><em>optional</em>) – Pixel size of the atlas used to find area if.
Defaults to 10.</p></li>
<li><p><strong>full_scale</strong> (<em>bool</em><em>, </em><em>optional</em>) – If true, returns the full scale image, otherwise
the downsample version used for registration. Defaults to False.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Image with area id of each pixel</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>area_id (np.array)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.ara_registration.overview_single_roi">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.ara_registration.</span></span><span class="sig-name descname"><span class="pre">overview_single_roi</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">slice_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chan2use=(0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">3)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sigma_blur=10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">agg_func=&lt;function</span> <span class="pre">nanmean&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reference_prefix='genes_round_1_1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subresolutions=5</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_pixel_size=2</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.ara_registration.overview_single_roi" title="Permalink to this definition">#</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.ara_registration.spots_ara_infos">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.ara_registration.</span></span><span class="sig-name descname"><span class="pre">spots_ara_infos</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spots</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atlas_size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">inplace</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.ara_registration.spots_ara_infos" title="Permalink to this definition">#</a></dt>
<dd><p>Add ARA coordinates and area ID to spots dataframe</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data</p></li>
<li><p><strong>spots</strong> (<em>pd.DataFrame</em>) – Spots dataframe</p></li>
<li><p><strong>atlas_size</strong> (<em>int</em>) – Atlas size (10, 25 or 50) for find areas borders</p></li>
<li><p><strong>inplace</strong> (<em>bool</em><em>, </em><em>optional</em>) – add the column to spots inplace or return a copy.
Defaults to True</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>reference or copy of spots dataframe with four more</dt><dd><p>columns: <cite>ara_x</cite>, <cite>ara_y</cite>, <cite>ara_z</cite>, and <cite>area_id</cite></p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>spots (pd.DataFrame)</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline.diagnostics">
<span id="iss-preprocess-pipeline-diagnostics-module"></span><h2>iss_preprocess.pipeline.diagnostics module<a class="headerlink" href="#module-iss_preprocess.pipeline.diagnostics" title="Permalink to this heading">#</a></h2>
<p>Module containing diagnostic plots to make sure steps of the pipeline run smoothly</p>
<p>The functions in here do not compute anything useful, but create figures</p>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.diagnostics.check_illumination_correction">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.diagnostics.</span></span><span class="sig-name descname"><span class="pre">check_illumination_correction</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">grand_averages</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">('barcode_round',</span> <span class="pre">'genes_round')</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">verbose</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.diagnostics.check_illumination_correction" title="Permalink to this definition">#</a></dt>
<dd><p>Check if illumination correction average look reasonable</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data folder</p></li>
<li><p><strong>grand_averages</strong> (<em>list</em>) – List of grand averages to plot.
Defaults to (“barcode_round”, “genes_round”)</p></li>
<li><p><strong>verbose</strong> (<em>bool</em>) – Print info about progress. Defaults to True</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline.hybridisation">
<span id="iss-preprocess-pipeline-hybridisation-module"></span><h2>iss_preprocess.pipeline.hybridisation module<a class="headerlink" href="#module-iss_preprocess.pipeline.hybridisation" title="Permalink to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.hybridisation.estimate_channel_correction_hybridisation">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.hybridisation.</span></span><span class="sig-name descname"><span class="pre">estimate_channel_correction_hybridisation</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.hybridisation.estimate_channel_correction_hybridisation" title="Permalink to this definition">#</a></dt>
<dd><p>Compute grayscale value distribution and normalisation factors for
all hybridisation rounds.</p>
<p>Each <cite>correction_tiles</cite> of <cite>ops</cite> is filtered before being used to compute the
distribution of pixel values.
Normalisation factor to equalise these distribution across channels and rounds are
defined as <cite>ops[“correction_quantile”]</cite> of the distribution.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>data_path</strong> (<em>str</em><em> or </em><em>Path</em>) – Relative path to the data folder</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>A 65536 x Nch x Nrounds distribution of grayscale values</dt><dd><p>for filtered stacks</p>
</dd>
</dl>
<p>norm_factors (np.array) A Nch x Nround array of normalisation factors</p>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pixel_dist (np.array)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.hybridisation.extract_hyb_spots_all">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.hybridisation.</span></span><span class="sig-name descname"><span class="pre">extract_hyb_spots_all</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.hybridisation.extract_hyb_spots_all" title="Permalink to this definition">#</a></dt>
<dd><p>Start <cite>sbatch</cite> jobs to detect hybridisation spots for each hybridisation
round and ROI.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.hybridisation.extract_hyb_spots_roi">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.hybridisation.</span></span><span class="sig-name descname"><span class="pre">extract_hyb_spots_roi</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.hybridisation.extract_hyb_spots_roi" title="Permalink to this definition">#</a></dt>
<dd><p>Detect hybridisation spots for a given hybridisation round and ROI.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – Prefix of the hybridisation round, e.g. “hybridisation_1_1”.</p></li>
<li><p><strong>roi</strong> (<em>int</em>) – ID of the ROI to process, as specified in MicroManager
(i.e. 1-based)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.hybridisation.extract_hyb_spots_tile">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.hybridisation.</span></span><span class="sig-name descname"><span class="pre">extract_hyb_spots_tile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.hybridisation.extract_hyb_spots_tile" title="Permalink to this definition">#</a></dt>
<dd><p>Detect hybridisation spots for a given tile.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>tile_coors</strong> (<em>tuple</em>) – Coordinates of tile to load: ROI, Xpos, Ypos.</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – Prefix of the hybridisation round, e.g. “hybridisation_1_1”.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.hybridisation.hyb_spot_cluster_means">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.hybridisation.</span></span><span class="sig-name descname"><span class="pre">hyb_spot_cluster_means</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">score_thresh</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.hybridisation.hyb_spot_cluster_means" title="Permalink to this definition">#</a></dt>
<dd><p>Estimate bleedthrough matrices for hybridisation spots. Spot
colors for each dye are initialized based on the metadata in the
hybridisation probe list.</p>
<p>Uses tiles specified in <cite>ops[“barcode_ref_tiles”]</cite>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – Prefix of hybridisation round, e.g. “hybridisation_1_1”.</p></li>
<li><p><strong>score_thresh</strong> (<em>int</em><em>, </em><em>optional</em>) – Threshold to apply during scaled k-means clustering.
Spots, whose dot product is below this threshold, will not contribute
to the estimate of the mean. Defaults to 0.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Nprobes x Nch bleedthrough matrix.
pandas.DataFrame: DataFrame of all detected spots across all tiles.
list: list of gene names based on probe metadata.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.hybridisation.load_and_register_hyb_tile">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.hybridisation.</span></span><span class="sig-name descname"><span class="pre">load_and_register_hyb_tile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(1,</span> <span class="pre">0,</span> <span class="pre">0)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'hybridisation_1_1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fstack'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filter_r</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(2,</span> <span class="pre">4)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_illumination</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_channels</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.hybridisation.load_and_register_hyb_tile" title="Permalink to this definition">#</a></dt>
<dd><p>Load hybridisation tile and align channels. Optionally, filter, correct
illumination and channel brightness.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>tile_coors</strong> (<em>tuple</em><em>, </em><em>options</em>) – Coordinates of tile to load: ROI, Xpos, Ypos.
Defaults to (1, 0, 0).</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix of the hybridisation round.
Defaults to “hybridisation_1_1”.</p></li>
<li><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Filename suffix corresponding to the z-projection
to use. Defaults to “fstack”.</p></li>
<li><p><strong>filter_r</strong> (<em>tuple</em><em>, </em><em>optional</em>) – Inner and out radius for the hanning filter.
If <cite>False</cite>, stack is not filtered. Defaults to (2, 4).</p></li>
<li><p><strong>correct_illumination</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to correct vignetting.
Defaults to False.</p></li>
<li><p><strong>correct_channels</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to normalize channel brightness.
Defaults to False.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><p>X x Y x Nch image stack.
numpy.ndarray: X x Y boolean mask, identifying bad pixels that we were not imaged</p>
<blockquote>
<div><p>for all channels (due to registration offsets) and should be discarded
during analysis.</p>
</div></blockquote>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.hybridisation.setup_hyb_spot_calling">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.hybridisation.</span></span><span class="sig-name descname"><span class="pre">setup_hyb_spot_calling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">score_thresh</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vis</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.hybridisation.setup_hyb_spot_calling" title="Permalink to this definition">#</a></dt>
<dd><p>Prepare and save bleedthrough matrices for hybridisation rounds.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data</p></li>
<li><p><strong>score_thresh</strong> (<em>int</em><em>, </em><em>optional</em>) – Threshold to apply during scaled k-means clustering.
Spots, whose dot product is below this threshold, will be not contribute
to the estimate of the mean. Defaults to 0.</p></li>
<li><p><strong>vis</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to generate diagnostic plots. Defaults to True.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline.pipeline">
<span id="iss-preprocess-pipeline-pipeline-module"></span><h2>iss_preprocess.pipeline.pipeline module<a class="headerlink" href="#module-iss_preprocess.pipeline.pipeline" title="Permalink to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.pipeline.batch_process_tiles">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.pipeline.</span></span><span class="sig-name descname"><span class="pre">batch_process_tiles</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">script</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">additional_args</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.pipeline.batch_process_tiles" title="Permalink to this definition">#</a></dt>
<dd><p>Start sbatch scripts for all tiles across all rois.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>script</strong> (<em>str</em>) – Filename stem of the sbatch script, e.g. <cite>extract_tile</cite>.</p></li>
<li><p><strong>additional_args</strong> (<em>str</em><em>, </em><em>optional</em>) – Additional environment variable to export
to pass to the sbatch job. Should start with a leading comma.
Defaults to “”.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.pipeline.create_all_single_averages">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.pipeline.</span></span><span class="sig-name descname"><span class="pre">create_all_single_averages</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">todo</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">('genes_rounds',</span> <span class="pre">'barcode_rounds',</span> <span class="pre">'fluorescence',</span> <span class="pre">'hybridisation')</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.pipeline.create_all_single_averages" title="Permalink to this definition">#</a></dt>
<dd><p>Average all tiffs in each folder and then all folders by acquisition type</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Path to data, relative to project.</p></li>
<li><p><strong>todo</strong> (<em>tuple</em>) – type of acquisition to process. Default to <cite>(“genes_rounds”,
“barcode_rounds”, “fluorescence”, “hybridisation”)</cite></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.pipeline.create_grand_averages">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.pipeline.</span></span><span class="sig-name descname"><span class="pre">create_grand_averages</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix_todo</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">('genes_round',</span> <span class="pre">'barcode_round')</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.pipeline.create_grand_averages" title="Permalink to this definition">#</a></dt>
<dd><p>Average single acquisition averages into grand average</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Path to the folder, relative to <cite>projects</cite> folder</p></li>
<li><p><strong>prefix_todo</strong> (<em>tuple</em><em>, </em><em>optional</em>) – List of str, names of the tifs to average.
Defaults to (“genes_round”, “barcode_round”).</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.pipeline.create_single_average">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.pipeline.</span></span><span class="sig-name descname"><span class="pre">create_single_average</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subfolder</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subtract_black</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix_filter</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">combine_tilestats</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.pipeline.create_single_average" title="Permalink to this definition">#</a></dt>
<dd><p>Create normalised average of all tifs in a single folder.</p>
<p>If prefix_filter is not None, the output will be “{prefix_filter}_average.tif”,
otherwise it will be “{folder_path.name}_average.tif”</p>
<dl class="simple">
<dt>Other arguments are read from <cite>ops</cite>:</dt><dd><p>average_clip_value: Value to clip images before averaging.
normalise: Normalise output maximum to one.</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Path to the acquisition folder, relative to <cite>projects</cite> folder</p></li>
<li><p><strong>subfolder</strong> (<em>str</em>) – subfolder in folder_path containing the tifs to average.</p></li>
<li><p><strong>subtract_black</strong> (<em>bool</em>) – Subtract black level (read from <cite>ops</cite>)</p></li>
<li><p><strong>prefix_filter</strong> (<em>str</em><em>, </em><em>optional</em>) – prefix name to filter tifs. Only file starting
with <cite>prefix</cite> will be averaged. Defaults to None.</p></li>
<li><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – suffix to filter tifs. Defaults to None</p></li>
<li><p><strong>combine_tilestats</strong> (<em>bool</em><em>, </em><em>optional</em>) – Compute new tilestats distribution of
averaged images if True, combine pre-existing tilestats into one otherwise.
Defaults to False</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Average image
np.array: Distribution of pixel values</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>np.array</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.pipeline.overview_for_ara_registration">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.pipeline.</span></span><span class="sig-name descname"><span class="pre">overview_for_ara_registration</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rois_to_do</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bulb_first</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sigma_blur</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.pipeline.overview_for_ara_registration" title="Permalink to this definition">#</a></dt>
<dd><p>Generate a stitched overview for registering to the ARA</p>
<p>ABBA requires pyramidal OME-TIFF with resolution information. We will generate such
stitched files and save them with a log yaml file indicating info about downsampling</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to the data folder</p></li>
<li><p><strong>rois_to_do</strong> (<em>list</em><em>, </em><em>optional</em>) – ROIs to process. If None (default), process all
ROIs</p></li>
<li><p><strong>max_pixel_size</strong> (<em>float</em><em>, </em><em>optional</em>) – Pixel size in um for the highest level of the
pyramid. None to keep original size. Defaults to 1</p></li>
<li><p><strong>bulb_first</strong> (<em>bool</em><em>, </em><em>optional</em>) – Was the first slice closer to the olfactory
bulb than the last? Defaults to True.</p></li>
<li><p><strong>sigma_blur</strong> (<em>float</em><em>, </em><em>optional</em>) – sigma of the gaussian filter, in downsampled
pixel size. Defaults to 10</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline.project">
<span id="iss-preprocess-pipeline-project-module"></span><h2>iss_preprocess.pipeline.project module<a class="headerlink" href="#module-iss_preprocess.pipeline.project" title="Permalink to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.project.check_projection">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.project.</span></span><span class="sig-name descname"><span class="pre">check_projection</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffixes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">('max',</span> <span class="pre">'fstack')</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.project.check_projection" title="Permalink to this definition">#</a></dt>
<dd><p>Check if all tiles have been projected successfully.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – Acquisition prefix, e.g. “genes_round_1_1”.</p></li>
<li><p><strong>suffixes</strong> (<em>tuple</em><em>, </em><em>optional</em>) – Projection suffixes to check for.
Defaults to (“max”, “fstack”).</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.project.project_round">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.project.</span></span><span class="sig-name descname"><span class="pre">project_round</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">overwrite</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.project.project_round" title="Permalink to this definition">#</a></dt>
<dd><p>Start SLURM jobs to z-project all tiles from a single imaging round.
Also, copy one of the MicroManager metadata files from raw to processed directory.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to dataset.</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – Full folder name prefix, including round number.</p></li>
<li><p><strong>overwrite</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to re-project if files already exist.
Defaults to False.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.project.project_tile">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.project.</span></span><span class="sig-name descname"><span class="pre">project_tile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fname</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">overwrite</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sth</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">13</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.project.project_tile" title="Permalink to this definition">#</a></dt>
<dd><p>Calculates extended depth of field and max intensity projections for a single tile.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fname</strong> (<em>str</em>) – path to tile <em>without</em> <cite>‘.ome.tif’</cite> extension.</p></li>
<li><p><strong>overwrite</strong> (<em>bool</em>) – whether to repeat if already completed</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.project.project_tile_by_coors">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.project.</span></span><span class="sig-name descname"><span class="pre">project_tile_by_coors</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">overwrite</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.project.project_tile_by_coors" title="Permalink to this definition">#</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.project.project_tile_row">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.project.</span></span><span class="sig-name descname"><span class="pre">project_tile_row</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_roi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_row</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_col</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">overwrite</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.project.project_tile_row" title="Permalink to this definition">#</a></dt>
<dd><p>Calculate max intensity and extended DOF projections for a row of tiles in an ROI.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – relative path to dataset</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – directory / file name prefix, e.g. ‘gene_round’</p></li>
<li><p><strong>tile_roi</strong> (<em>int</em>) – index of the ROI</p></li>
<li><p><strong>tile_row</strong> (<em>int</em>) – index of the row to process</p></li>
<li><p><strong>max_col</strong> (<em>int</em>) – maximum columns index. Will project tiles from column 0 to max_col</p></li>
<li><p><strong>overwrite</strong> (<em>bool</em><em>, </em><em>optional</em>) – whether to redo projection if files already exist.
Defaults to False.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline.register">
<span id="iss-preprocess-pipeline-register-module"></span><h2>iss_preprocess.pipeline.register module<a class="headerlink" href="#module-iss_preprocess.pipeline.register" title="Permalink to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.register.correct_hyb_shifts">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.register.</span></span><span class="sig-name descname"><span class="pre">correct_hyb_shifts</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.register.correct_hyb_shifts" title="Permalink to this definition">#</a></dt>
<dd><p>Use robust regression across tiles to correct shifts and angles
for hybridisation rounds. Either processes a specific hybridisation
round or all rounds.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – Directory prefix to use, e.g. “genes_round”. If None,
processes all rounds.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.register.correct_hyb_shifts_roi">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.register.</span></span><span class="sig-name descname"><span class="pre">correct_hyb_shifts_roi</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi_dims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'hybridisation_1_1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_shift</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">500</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.register.correct_hyb_shifts_roi" title="Permalink to this definition">#</a></dt>
<dd><p>Use robust regression across tiles to correct shifts and angles
for a single hybridisation round and ROI.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>roi_dims</strong> (<em>tuple</em>) – Dimensions of the ROI to be processed, in (ROI_ID, Xtiles, Ytiles)
format.</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix of the round to be processed.
Defaults to “hybridisation_1_1”.</p></li>
<li><p><strong>max_shift</strong> (<em>int</em><em>, </em><em>optional</em>) – Maximum shift to include tiles in RANSAC regression.
Tiles with larger absolute shifts will not be included in the fit but will
still have their corrected shifts estimated. Defaults to 500.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.register.correct_shifts">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.register.</span></span><span class="sig-name descname"><span class="pre">correct_shifts</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.register.correct_shifts" title="Permalink to this definition">#</a></dt>
<dd><p>Use robust regression to correct shifts across tiles within an ROI
for all ROIs.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – Directory prefix to use, e.g. “genes_round”.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.register.correct_shifts_roi">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.register.</span></span><span class="sig-name descname"><span class="pre">correct_shifts_roi</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi_dims</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_shift</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">500</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.register.correct_shifts_roi" title="Permalink to this definition">#</a></dt>
<dd><p>Use robust regression to correct shifts across tiles for a single ROI.</p>
<p>RANSAC regression is applied to shifts within and across channels using
tile X and Y position as predictors.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>roi_dims</strong> (<em>tuple</em>) – Dimensions of the ROI to be processed, in (ROI_ID, Xtiles, Ytiles)
format.</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Directory prefix to use. Defaults to “genes_round”.</p></li>
<li><p><strong>max_shift</strong> (<em>int</em><em>, </em><em>optional</em>) – Maximum shift to include tiles in RANSAC regression.
Tiles with larger absolute shifts will not be included in the fit but will
still have their corrected shifts estimated. Defaults to 500.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.register.estimate_shifts_and_angles_by_coors">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.register.</span></span><span class="sig-name descname"><span class="pre">estimate_shifts_and_angles_by_coors</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(0,</span> <span class="pre">0,</span> <span class="pre">0)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'hybridisation_1_1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fstack'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reference_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'barcode_round'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.register.estimate_shifts_and_angles_by_coors" title="Permalink to this definition">#</a></dt>
<dd><p>Estimate shifts and rotations angles for hybridisation images.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>tile_coors</strong> (<em>tuple</em><em>, </em><em>optional</em>) – Coordinates of tile to register, in (ROI, X, Y)
format. Defaults to (0, 0, 0).</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix of the hybridisation round. Defaults to “hybridisation_1_1”.</p></li>
<li><p><strong>reference_prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix to use for loading precomputed
scale factors between channels. Defaults to “barcode_round”.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.register.estimate_shifts_by_coors">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.register.</span></span><span class="sig-name descname"><span class="pre">estimate_shifts_by_coors</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(0,</span> <span class="pre">0,</span> <span class="pre">0)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fstack'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.register.estimate_shifts_by_coors" title="Permalink to this definition">#</a></dt>
<dd><p>Estimate shifts across channels and sequencing rounds using provided reference
rotation angles and scale factors.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>tile_coors</strong> (<em>tuple</em><em>, </em><em>optional</em>) – Coordinates of tile to register, in (ROI, X, Y)
format. Defaults to (0, 0, 0).</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Directory prefix to register. Defaults to “genes_round”.</p></li>
<li><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Filename suffix specifying which z-projection to use.
Defaults to “fstack”.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.register.register_reference_tile">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.register.</span></span><span class="sig-name descname"><span class="pre">register_reference_tile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.register.register_reference_tile" title="Permalink to this definition">#</a></dt>
<dd><p>Estimate round and channel registration parameters for
the specified tile, include shifts and rotations between rounds
and shifts, rotations, and scaling between channels.</p>
<p>Shifts are estimated using phase correlation. Rotation and
scaling are estimated using iterative grid search.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Directory prefix to register.
Defaults to “genes_round”.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline.segment">
<span id="iss-preprocess-pipeline-segment-module"></span><h2>iss_preprocess.pipeline.segment module<a class="headerlink" href="#module-iss_preprocess.pipeline.segment" title="Permalink to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.segment.segment_all_rois">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.segment.</span></span><span class="sig-name descname"><span class="pre">segment_all_rois</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'DAPI_1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_gpu</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.segment.segment_all_rois" title="Permalink to this definition">#</a></dt>
<dd><p>Start batch jobs for segmentation for each ROI.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – acquisition prefix to use for segmentation.
Defaults to “DAPI_1”.</p></li>
<li><p><strong>use_gpu</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to use GPU. Defaults to False.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.segment.segment_roi">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.segment.</span></span><span class="sig-name descname"><span class="pre">segment_roi</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">iroi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'DAPI_1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reference</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round_1_1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_gpu</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.segment.segment_roi" title="Permalink to this definition">#</a></dt>
<dd><p>Detect cells in a single ROI using Cellpose.</p>
<p>Much faster with GPU but requires very amount of VRAM for large ROIs.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>iroi</strong> (<em>int</em>) – ROI ID to segment as specificied in MicroManager (i.e. 1-based).</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Acquisition prefix to use for segmentation. Defaults to “DAPI_1”.</p></li>
<li><p><strong>reference</strong> (<em>str</em><em>, </em><em>optional</em>) – Acquisition prefix to align the stitched image to.
Defaults to “genes_round_1_1”.</p></li>
<li><p><strong>use_gpu</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to use GPU. Defaults to False.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline.sequencing">
<span id="iss-preprocess-pipeline-sequencing-module"></span><h2>iss_preprocess.pipeline.sequencing module<a class="headerlink" href="#module-iss_preprocess.pipeline.sequencing" title="Permalink to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.sequencing.basecall_tile">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.sequencing.</span></span><span class="sig-name descname"><span class="pre">basecall_tile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.sequencing.basecall_tile" title="Permalink to this definition">#</a></dt>
<dd><p>Detect and basecall barcodes for a given tile.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>tile_coors</strong> (<em>tuple</em><em>, </em><em>optional</em>) – Coordinates of tile to load: ROI, Xpos, Ypos.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.sequencing.estimate_channel_correction">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.sequencing.</span></span><span class="sig-name descname"><span class="pre">estimate_channel_correction</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nrounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">7</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.sequencing.estimate_channel_correction" title="Permalink to this definition">#</a></dt>
<dd><p>Compute grayscale value distribution and normalisation factors</p>
<p>Each <cite>correction_tiles</cite> of <cite>ops</cite> is filtered before being used to compute the
distribution of pixel values.
Normalisation factor to equalise these distribution across channels and rounds are
defined as <cite>ops[“correction_quantile”]</cite> of the distribution.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em><em> or </em><em>Path</em>) – Relative path to the data folder</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Folder name prefix, before round number. Defaults
to “round”.</p></li>
<li><p><strong>nrounds</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of rounds. Defaults to 7.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>A 65536 x Nch x Nrounds distribution of grayscale values</dt><dd><p>for filtered stacks</p>
</dd>
</dl>
<p>norm_factors (np.array) A Nch x Nround array of normalisation factors</p>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pixel_dist (np.array)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.sequencing.load_and_register_tile">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.sequencing.</span></span><span class="sig-name descname"><span class="pre">load_and_register_tile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(1,</span> <span class="pre">0,</span> <span class="pre">0)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fstack'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filter_r</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(2,</span> <span class="pre">4)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_channels</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">corrected_shifts</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_illumination</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nrounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">7</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.sequencing.load_and_register_tile" title="Permalink to this definition">#</a></dt>
<dd><p>Load sequencing tile and align channels. Optionally, filter, correct
illumination and channel brightness.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>tile_coors</strong> (<em>tuple</em><em>, </em><em>options</em>) – Coordinates of tile to load: ROI, Xpos, Ypos.
Defaults to (1, 0, 0).</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix of the hybridisation round.
Defaults to “hybridisation_1_1”.</p></li>
<li><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Filename suffix corresponding to the z-projection
to use. Defaults to “fstack”.</p></li>
<li><p><strong>filter_r</strong> (<em>tuple</em><em>, </em><em>optional</em>) – Inner and out radius for the hanning filter.
If <cite>False</cite>, stack is not filtered. Defaults to (2, 4).</p></li>
<li><p><strong>correct_channels</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to normalize channel brightness.
Defaults to False.</p></li>
<li><p><strong>corrected_shifts</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to use corrected shifts estimated
by robust regression across tiles. Defaults to True.</p></li>
<li><p><strong>correct_illumination</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to correct vignetting.
Defaults to False.</p></li>
<li><p><strong>nrounds</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of sequencing rounds to load. Defaults to 7.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><p>X x Y x Nch x Nrounds image stack.
numpy.ndarray: X x Y boolean mask, identifying bad pixels that we were not imaged</p>
<blockquote>
<div><p>for all channels and rounds (due to registration offsets) and should be discarded
during analysis.</p>
</div></blockquote>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.sequencing.load_sequencing_rounds">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.sequencing.</span></span><span class="sig-name descname"><span class="pre">load_sequencing_rounds</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(1,</span> <span class="pre">0,</span> <span class="pre">0)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nrounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">7</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fstack'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'round'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.sequencing.load_sequencing_rounds" title="Permalink to this definition">#</a></dt>
<dd><p>Load processed tile images across rounds</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – relative path to dataset.</p></li>
<li><p><strong>tile_coors</strong> (<em>tuple</em><em>, </em><em>optional</em>) – Coordinates of tile to load: ROI, Xpos, Ypos.
Defaults to (1,0,0).</p></li>
<li><p><strong>nrounds</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of rounds to load. Defaults to 7.</p></li>
<li><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – File name suffix. Defaults to ‘fstack’.</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – the folder name prefix, before round number. Defaults
to “round”</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>X x Y x channels x rounds stack.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.sequencing.load_spot_sign_image">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.sequencing.</span></span><span class="sig-name descname"><span class="pre">load_spot_sign_image</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">threshold</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.sequencing.load_spot_sign_image" title="Permalink to this definition">#</a></dt>
<dd><p>Load the reference spot sign image to use in spot calling. First, check
if the spot sign image has been computed for the current dataset and use it
if available. Otherwise, use the spot sign image saved in the repo.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>threshold</strong> (<em>float</em>) – Absolute value threshold used to binarize the spot
sign image.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Spot sign image after thresholding, containing -1, 0, or 1s.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.sequencing.run_omp_on_tile">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.sequencing.</span></span><span class="sig-name descname"><span class="pre">run_omp_on_tile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_coors</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_stack</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_channels</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.sequencing.run_omp_on_tile" title="Permalink to this definition">#</a></dt>
<dd><p>Apply the OMP algorithm to unmix spots in a given tile using the saved
gene dictionary and settings saved in <cite>ops.npy</cite>. Then detect gene spots in
the resulting gene maps.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>tile_coors</strong> (<em>tuple</em>) – Coordinates of tile to load: ROI, Xpos, Ypos.</p></li>
<li><p><strong>save_stack</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to save registered and preprocessed images.
Defaults to False.</p></li>
<li><p><strong>correct_channels</strong> (<em>bool</em><em> or </em><em>str</em><em>, </em><em>optional</em>) – Whether to apply channel normalization.
If not False, can specify normalization method, e.g. “round1_only”. Defaults to False.</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix of the sequencing read to analyse.
Defaults to “genes_round”.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.sequencing.setup_barcode_calling">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.sequencing.</span></span><span class="sig-name descname"><span class="pre">setup_barcode_calling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">score_thresh</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.5</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spot_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_channels</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.sequencing.setup_barcode_calling" title="Permalink to this definition">#</a></dt>
<dd><p>Detect spot and compute cluster means</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data</p></li>
<li><p><strong>score_thresh</strong> (<em>float</em><em>, </em><em>optional</em>) – score_thresh argument for get_cluster_mean.
Defaults to 0.5.</p></li>
<li><p><strong>spot_size</strong> (<em>int</em><em>, </em><em>optional</em>) – Size of the spots in pixels. Defaults to 2.</p></li>
<li><p><strong>correct_channels</strong> (<em>bool</em><em>, </em><em>optional</em>) – Correct intensity difference across channel.
True to normalise all rounds individually. <cite>round1_only</cite> to normalise all
rounds to round1 correction. False to remove correction. Defaults to False.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>A list with Nrounds elements. Each a Nch x Ncl (square</dt><dd><p>because N channels is equal to N clusters) array of cluster means,
normalised by round 0 intensity</p>
</dd>
</dl>
<p>all_spots (pandas.DataFrame): All detected spots.</p>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>cluster_means (list)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.sequencing.setup_omp">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.sequencing.</span></span><span class="sig-name descname"><span class="pre">setup_omp</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stack</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">codebook_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'codebook_83gene_pool.csv'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detection_threshold</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">40</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">isolation_threshold</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">30</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.sequencing.setup_omp" title="Permalink to this definition">#</a></dt>
<dd><p>Prepare variables required to run the OMP algorithm. Finds isolated spots using
STD across rounds and channels. Detected spots are then used to determine the
bleedthrough matrix using scaled k-means.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>stack</strong> (<em>numpy.ndarray</em>) – X x Y x C x R image stack.</p></li>
<li><p><strong>codebook_name</strong> (<em>str</em>) – filename of the codebook to use.</p></li>
<li><p><strong>detection_threshold</strong> (<em>float</em>) – spot detection threshold to find spots for
training the bleedthrough matrix.</p></li>
<li><p><strong>isolation_threshold</strong> (<em>float</em>) – threshold used to selected isolated spots
based on average values in the annulus around each spot.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>N x M dictionary, where N = R * C and M is the</dt><dd><p>number of genes.</p>
</dd>
</dl>
<p>list: gene names.
float: norm shift for the OMP algorithm, estimated as median norm of all pixels.</p>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline.stitch">
<span id="iss-preprocess-pipeline-stitch-module"></span><h2>iss_preprocess.pipeline.stitch module<a class="headerlink" href="#module-iss_preprocess.pipeline.stitch" title="Permalink to this heading">#</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.stitch.calculate_tile_positions">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.stitch.</span></span><span class="sig-name descname"><span class="pre">calculate_tile_positions</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">shift_right</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shift_down</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_shape</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ntiles</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.stitch.calculate_tile_positions" title="Permalink to this definition">#</a></dt>
<dd><p>Calculate position of each tile based on the provided shifts.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>shift_right</strong> (<em>numpy.array</em>) – X and Y shifts between different columns</p></li>
<li><p><strong>shift_down</strong> (<em>numpy.array</em>) – X and Y shifts between different rows</p></li>
<li><p><strong>tile_shape</strong> (<em>numpy.array</em>) – shape of each tile</p></li>
<li><p><strong>ntiles</strong> (<em>numpy.array</em>) – number of tile rows and columns</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><cite>tile_origins</cite>, ntiles[0] x ntiles[1] x 2 matrix of tile origin coordinates
numpy.ndarray: <cite>tile_centers</cite>, ntiles[0] x ntiles[1] x 2 matrix of tile center coordinates</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.stitch.merge_and_align_spots">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.stitch.</span></span><span class="sig-name descname"><span class="pre">merge_and_align_spots</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spots_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'barcode_round'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reg_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'barcode_round_1_1'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.stitch.merge_and_align_spots" title="Permalink to this definition">#</a></dt>
<dd><p>Combine spots across tiles and align to reference coordinates for a single ROI.</p>
<p>We first generate a DataFrame containing all spots in global coordinates
of the acquisition they were detected in using <cite>merge_roi_spots</cite>. We then
transform their coordinates into coordinates of the reference genes round
using the transformation estimated by <cite>stitch_and_register</cite>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>roi</strong> (<em>int</em>) – ROI ID to process (as specified in MicroManager).</p></li>
<li><p><strong>spots_prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Filename prefix of the spot files to combine.
Defaults to “barcode_round”.</p></li>
<li><p><strong>reg_prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Acquisition prefix of the image files to use to
estimate the tranformation to reference image. Defaults to “barcode_round_1_1”.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.stitch.merge_and_align_spots_all_rois">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.stitch.</span></span><span class="sig-name descname"><span class="pre">merge_and_align_spots_all_rois</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spots_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'barcode_round'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reg_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'barcode_round_1_1'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.stitch.merge_and_align_spots_all_rois" title="Permalink to this definition">#</a></dt>
<dd><p>Start batch jobs to combine spots across tiles and align to reference coordinates
for all ROIs.</p>
<blockquote>
<div><dl>
<dt>Args:</dt><dd><p>data_path (str): Relative path to data.
spots_prefix (str, optional): Filename prefix of the spot files to combine.</p>
<blockquote>
<div><p>Defaults to “barcode_round”.</p>
</div></blockquote>
<dl class="simple">
<dt>reg_prefix (str, optional): Acquisition prefix of the image files to use to</dt><dd><p>estimate the tranformation to reference image. Defaults to “barcode_round_1_1”.</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.stitch.merge_roi_spots">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.stitch.</span></span><span class="sig-name descname"><span class="pre">merge_roi_spots</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shift_right</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shift_down</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_shape</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">iroi</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.stitch.merge_roi_spots" title="Permalink to this definition">#</a></dt>
<dd><p>Load and combine spot locations across all tiles for an ROI.</p>
<p>To avoid duplicate spots from tile overlap, we determine which tile center
each spot is closest to. We then only keep the spots that are closest to
the center of the tile they were detected on.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – path to pickle files containing spot locations for each tile.</p></li>
<li><p><strong>shift_right</strong> (<em>numpy.array</em>) – X and Y shifts between different columns</p></li>
<li><p><strong>shift_down</strong> (<em>numpy.array</em>) – X and Y shifts between different rows</p></li>
<li><p><strong>tile_shape</strong> (<em>numpy.array</em>) – shape of each tile</p></li>
<li><p><strong>iroi</strong> (<em>int</em><em>, </em><em>optional</em>) – ID of ROI to load. Defaults to 1.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>table containing spot locations across all tiles.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pandas.DataFrame</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.stitch.register_adjacent_tiles">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.stitch.</span></span><span class="sig-name descname"><span class="pre">register_adjacent_tiles</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ref_coors</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(1,</span> <span class="pre">0,</span> <span class="pre">0)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reg_fraction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ref_ch</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fstack'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'genes_round'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.stitch.register_adjacent_tiles" title="Permalink to this definition">#</a></dt>
<dd><p>Estimate shift between adjacent imaging tiles using phase correlation.</p>
<p>Shifts are typically very similar between different tiles, using shifts
estimated using a reference tile for the whole acquisition works well.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – path to image stacks.</p></li>
<li><p><strong>ref_coors</strong> (<em>tuple</em><em>, </em><em>optional</em>) – coordinates of the reference tile to use for
registration. Must not be along the bottom or right edge of image. Defaults to (1,0,0).</p></li>
<li><p><strong>reg_fraction</strong> (<em>float</em><em>, </em><em>optional</em>) – overlap fraction used for registration. Defaults to 0.1.</p></li>
<li><p><strong>ref_ch</strong> (<em>int</em><em>, </em><em>optional</em>) – reference channel used for registration. Defaults to 0.</p></li>
<li><p><strong>ref_round</strong> (<em>int</em><em>, </em><em>optional</em>) – reference round used for registration. Defaults to 0.</p></li>
<li><p><strong>nrounds</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of rounds to load. Defaults to 7.</p></li>
<li><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – File name suffix. Defaults to ‘proj’.</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – the folder name prefix, before round number. Defaults to “round”</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><cite>shift_right</cite>, X and Y shifts between different columns
numpy.array: <cite>shift_down</cite>, X and Y shifts between different rows
numpy.array: shape of the tile</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.array</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.stitch.stitch_and_register">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.stitch.</span></span><span class="sig-name descname"><span class="pre">stitch_and_register</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reference_prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">downsample</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">5</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ref_ch</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_ch</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">estimate_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.stitch.stitch_and_register" title="Permalink to this definition">#</a></dt>
<dd><p>Stitch target and reference stacks and align target to reference</p>
<p>To speed up registration, images are downsampled before estimating registration
parameters. These parameters are then applied to the full scale image.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – Relative path to data.</p></li>
<li><p><strong>reference_prefix</strong> (<em>str</em>) – Acquisition prefix to register the stitched image to.
Typically, “genes_round_1_1”.</p></li>
<li><p><strong>target_prefix</strong> (<em>str</em>) – Acquisition prefix to register.</p></li>
<li><p><strong>roi</strong> (<em>int</em><em>, </em><em>optional</em>) – ROI ID to register (as specified in MicroManager).
Defaults to 1.</p></li>
<li><p><strong>downsample</strong> (<em>int</em><em>, </em><em>optional</em>) – Downsample factor for estimating registration
parameter. Defaults to 5.</p></li>
<li><p><strong>ref_ch</strong> (<em>int</em><em>, </em><em>optional</em>) – Channel of the reference image used for registration.
Defaults to 0.</p></li>
<li><p><strong>target_ch</strong> (<em>int</em><em>, </em><em>optional</em>) – Channel of the target image used for registration.
Defaults to 0.</p></li>
<li><p><strong>estimate_scale</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to estimate scaling between target
and reference images. Defaults to False.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Stitched target image after registration.
numpy.ndarray: Stitched reference image.
float: Estimate rotation angle.
tuple: Estimated X and Y shifts.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="iss_preprocess.pipeline.stitch.stitch_tiles">
<span class="sig-prename descclassname"><span class="pre">iss_preprocess.pipeline.stitch.</span></span><span class="sig-name descname"><span class="pre">stitch_tiles</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shift_right</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shift_down</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fstack'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ich</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_illumination</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#iss_preprocess.pipeline.stitch.stitch_tiles" title="Permalink to this definition">#</a></dt>
<dd><p>Load and stitch tile images using provided tile shifts.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_path</strong> (<em>str</em>) – path to image stacks.</p></li>
<li><p><strong>prefix</strong> (<em>str</em>) – prefix specifying which images to load, e.g. ‘round_01_1’</p></li>
<li><p><strong>shift_right</strong> (<em>tuple</em>) – x and y shift between tiles along a row</p></li>
<li><p><strong>shift_down</strong> (<em>tuple</em>) – x and y shift between tiles along a column</p></li>
<li><p><strong>roi</strong> (<em>int</em><em>, </em><em>optional</em>) – id of ROI to load. Defaults to 1.</p></li>
<li><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – filename suffix. Defaults to ‘proj’.</p></li>
<li><p><strong>ich</strong> (<em>int</em><em>, </em><em>optional</em>) – index of the channel to stitch. Defaults to 0.</p></li>
<li><p><strong>correct_illumination</strong> (<em>bool</em><em>, </em><em>optional</em>) – Remove black levels and correct
illumination if True, return raw data otherwise. Default to False</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>stitched image.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-iss_preprocess.pipeline">
<span id="module-contents"></span><h2>Module contents<a class="headerlink" href="#module-iss_preprocess.pipeline" title="Permalink to this heading">#</a></h2>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Znamenskiy lab
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">iss_preprocess.pipeline package</a><ul>
<li><a class="reference internal" href="#submodules">Submodules</a></li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.ara_registration">iss_preprocess.pipeline.ara_registration module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.ara_registration.find_roi_position_on_cryostat"><code class="docutils literal notranslate"><span class="pre">find_roi_position_on_cryostat()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.ara_registration.load_coordinate_image"><code class="docutils literal notranslate"><span class="pre">load_coordinate_image()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.ara_registration.load_registration_reference_metadata"><code class="docutils literal notranslate"><span class="pre">load_registration_reference_metadata()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.ara_registration.make_area_image"><code class="docutils literal notranslate"><span class="pre">make_area_image()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.ara_registration.overview_single_roi"><code class="docutils literal notranslate"><span class="pre">overview_single_roi()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.ara_registration.spots_ara_infos"><code class="docutils literal notranslate"><span class="pre">spots_ara_infos()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.diagnostics">iss_preprocess.pipeline.diagnostics module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.diagnostics.check_illumination_correction"><code class="docutils literal notranslate"><span class="pre">check_illumination_correction()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.hybridisation">iss_preprocess.pipeline.hybridisation module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.hybridisation.estimate_channel_correction_hybridisation"><code class="docutils literal notranslate"><span class="pre">estimate_channel_correction_hybridisation()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.hybridisation.extract_hyb_spots_all"><code class="docutils literal notranslate"><span class="pre">extract_hyb_spots_all()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.hybridisation.extract_hyb_spots_roi"><code class="docutils literal notranslate"><span class="pre">extract_hyb_spots_roi()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.hybridisation.extract_hyb_spots_tile"><code class="docutils literal notranslate"><span class="pre">extract_hyb_spots_tile()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.hybridisation.hyb_spot_cluster_means"><code class="docutils literal notranslate"><span class="pre">hyb_spot_cluster_means()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.hybridisation.load_and_register_hyb_tile"><code class="docutils literal notranslate"><span class="pre">load_and_register_hyb_tile()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.hybridisation.setup_hyb_spot_calling"><code class="docutils literal notranslate"><span class="pre">setup_hyb_spot_calling()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.pipeline">iss_preprocess.pipeline.pipeline module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.pipeline.batch_process_tiles"><code class="docutils literal notranslate"><span class="pre">batch_process_tiles()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.pipeline.create_all_single_averages"><code class="docutils literal notranslate"><span class="pre">create_all_single_averages()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.pipeline.create_grand_averages"><code class="docutils literal notranslate"><span class="pre">create_grand_averages()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.pipeline.create_single_average"><code class="docutils literal notranslate"><span class="pre">create_single_average()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.pipeline.overview_for_ara_registration"><code class="docutils literal notranslate"><span class="pre">overview_for_ara_registration()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.project">iss_preprocess.pipeline.project module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.project.check_projection"><code class="docutils literal notranslate"><span class="pre">check_projection()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.project.project_round"><code class="docutils literal notranslate"><span class="pre">project_round()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.project.project_tile"><code class="docutils literal notranslate"><span class="pre">project_tile()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.project.project_tile_by_coors"><code class="docutils literal notranslate"><span class="pre">project_tile_by_coors()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.project.project_tile_row"><code class="docutils literal notranslate"><span class="pre">project_tile_row()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.register">iss_preprocess.pipeline.register module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.register.correct_hyb_shifts"><code class="docutils literal notranslate"><span class="pre">correct_hyb_shifts()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.register.correct_hyb_shifts_roi"><code class="docutils literal notranslate"><span class="pre">correct_hyb_shifts_roi()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.register.correct_shifts"><code class="docutils literal notranslate"><span class="pre">correct_shifts()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.register.correct_shifts_roi"><code class="docutils literal notranslate"><span class="pre">correct_shifts_roi()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.register.estimate_shifts_and_angles_by_coors"><code class="docutils literal notranslate"><span class="pre">estimate_shifts_and_angles_by_coors()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.register.estimate_shifts_by_coors"><code class="docutils literal notranslate"><span class="pre">estimate_shifts_by_coors()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.register.register_reference_tile"><code class="docutils literal notranslate"><span class="pre">register_reference_tile()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.segment">iss_preprocess.pipeline.segment module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.segment.segment_all_rois"><code class="docutils literal notranslate"><span class="pre">segment_all_rois()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.segment.segment_roi"><code class="docutils literal notranslate"><span class="pre">segment_roi()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.sequencing">iss_preprocess.pipeline.sequencing module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.sequencing.basecall_tile"><code class="docutils literal notranslate"><span class="pre">basecall_tile()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.sequencing.estimate_channel_correction"><code class="docutils literal notranslate"><span class="pre">estimate_channel_correction()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.sequencing.load_and_register_tile"><code class="docutils literal notranslate"><span class="pre">load_and_register_tile()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.sequencing.load_sequencing_rounds"><code class="docutils literal notranslate"><span class="pre">load_sequencing_rounds()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.sequencing.load_spot_sign_image"><code class="docutils literal notranslate"><span class="pre">load_spot_sign_image()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.sequencing.run_omp_on_tile"><code class="docutils literal notranslate"><span class="pre">run_omp_on_tile()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.sequencing.setup_barcode_calling"><code class="docutils literal notranslate"><span class="pre">setup_barcode_calling()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.sequencing.setup_omp"><code class="docutils literal notranslate"><span class="pre">setup_omp()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline.stitch">iss_preprocess.pipeline.stitch module</a><ul>
<li><a class="reference internal" href="#iss_preprocess.pipeline.stitch.calculate_tile_positions"><code class="docutils literal notranslate"><span class="pre">calculate_tile_positions()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.stitch.merge_and_align_spots"><code class="docutils literal notranslate"><span class="pre">merge_and_align_spots()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.stitch.merge_and_align_spots_all_rois"><code class="docutils literal notranslate"><span class="pre">merge_and_align_spots_all_rois()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.stitch.merge_roi_spots"><code class="docutils literal notranslate"><span class="pre">merge_roi_spots()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.stitch.register_adjacent_tiles"><code class="docutils literal notranslate"><span class="pre">register_adjacent_tiles()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.stitch.stitch_and_register"><code class="docutils literal notranslate"><span class="pre">stitch_and_register()</span></code></a></li>
<li><a class="reference internal" href="#iss_preprocess.pipeline.stitch.stitch_tiles"><code class="docutils literal notranslate"><span class="pre">stitch_tiles()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-iss_preprocess.pipeline">Module contents</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/furo.js"></script>
    </body>
</html>
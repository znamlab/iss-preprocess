<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Calling spots" href="call.html" /><link rel="prev" title="Crunch the data" href="project_and_average.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Registration - iss-preprocess 0.2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">iss-preprocess 0.2.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">iss-preprocess 0.2.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="project_and_average.html">Crunch the data</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="call.html">Calling spots</a></li>
<li class="toctree-l1"><a class="reference internal" href="correction.html">Channel brightness and illumination correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="bleedthrough.html">Bleedthrough matrix estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="sequencing.html">Calling various spots</a></li>
<li class="toctree-l1"><a class="reference internal" href="hybridisation.html">Detecting hybridisation spots</a></li>
<li class="toctree-l1"><a class="reference internal" href="segmentation.html">Cell segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="detect_mcherry.html">Detection mCherry cells</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API reference:</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="iss_preprocess.html">iss_preprocess package</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of iss_preprocess package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.call.html">iss_preprocess.call package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.config.html">iss_preprocess.config package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.coppafish.html">iss_preprocess.coppafish package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.diagnostics.html">iss_preprocess.diagnostics package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.image.html">iss_preprocess.image package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.io.html">iss_preprocess.io package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.pipeline.html">iss_preprocess.pipeline package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.reg.html">iss_preprocess.reg package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.segment.html">iss_preprocess.segment package</a></li>
<li class="toctree-l2"><a class="reference internal" href="iss_preprocess.vis.html">iss_preprocess.vis package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="flowchart_legends.html">Flowcharts legends</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/registration.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="registration">
<h1>Registration<a class="headerlink" href="#registration" title="Link to this heading">¶</a></h1>
<p>Final data is in one common coordinate system. It takes quite a few steps to get that.
This file describe how genes and barcodes are registered together.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The command is run as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>iss<span class="w"> </span>register<span class="w"> </span>--path<span class="w"> </span>relative/path/to/data<span class="w"> </span>--prefix<span class="w"> </span>genes_round
</pre></div>
</div>
<p>By default, the script will perform only missing steps. There is a <code class="docutils literal notranslate"><span class="pre">--force-redo</span></code> flag
that will force the script to re-run all steps, even if the output files already exist.</p>
<p>The script will perform different steps depending on the type of acquisition. See
details for <cite>sequencing</cite> and <cite>fluorescent</cite> acquisitions.</p>
<p>To check that everything worked, look in <cite>figures/registration/prefix</cite> for diagnostic
plots. If there is no motion on the <cite>mp4</cite> files for sequencing acquisitions, you’re
good. For fluorescent acquisitions, you should see that the spots are aligned across
channels on the <cite>png</cite>.</p>
<p>If it looks bad, see the relevant <cite>Troubleshooting</cite> section below.</p>
</section>
<section id="register-sequencing-acquisitions">
<h2>Register Sequencing acquisitions<a class="headerlink" href="#register-sequencing-acquisitions" title="Link to this heading">¶</a></h2>
<p>These are acquisitions that have multiple rounds, namely <cite>genes_round</cite> and
<cite>barcode_round</cite>. The steps are:</p>
<pre  class="mermaid">
        flowchart TD
start[Start] --&gt; regref[run_register_reference_tile];
    batch_est(((register_tile)));

    subgraph register_reference_tile
        regref --&gt; diag_ref([check_ref_tile_registration]);
    end



    regref --&gt; batch_est;
    batch_est --&gt; corr;
    subgraph correct_shifts
        subgraph run_correct_shifts
            corr[run_correct_shifts];
            corr --&gt; filt[filter_ransac_shifts];
        end

        subgraph check_tile_shifts
            filt --&gt; ctr([check_tile_registration]);
        end
        subgraph check_shift_correction
            filt --&gt; csc([check_shift_correction]);
        end
        subgraph check_tile_registration
            ctr --&gt; diag_tile([check_tile_registration]);
        end
    end

    style batch_est fill:#E1BEE7,stroke:#424242

    style corr stroke:#000000,fill:#E1BEE7
    style regref stroke:#000000,fill:#E1BEE7
    style filt stroke:#000000,fill:#E1BEE7

    style csc fill:#BBDEFB,stroke:#616161,color:#000000
    style diag_ref fill:#BBDEFB,stroke:#616161,color:#000000
    style diag_tile fill:#BBDEFB,stroke:#616161,color:#000000
    style ctr fill:#BBDEFB,stroke:#616161,color:#000000

    style run_correct_shifts fill:#EEEEEE, stroke:#424242
    style check_tile_shifts fill:#EEEEEE, stroke:#424242
    style check_shift_correction fill:#EEEEEE, stroke:#424242
    style check_tile_registration fill:#EEEEEE, stroke:#424242

    style correct_shifts fill:#AAAAAA, stroke:#424242
    style register_reference_tile fill:#AAAAAA, stroke:#424242
    </pre><section id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h3>
<p>If the registration looks bad, we need to find which step failed.</p>
<ul class="simple">
<li><p>Is the reference tile registered properly?</p></li>
</ul>
<p>In the <code class="docutils literal notranslate"><span class="pre">figures/registration</span></code> folder, look at the files starting with
<code class="docutils literal notranslate"><span class="pre">registration_reference_tile</span></code>. If there is no or little signal: pick a better
tile (change the <code class="docutils literal notranslate"><span class="pre">'ref_tile'</span></code> parameter in the <code class="docutils literal notranslate"><span class="pre">ops.yml</span></code> file). If there is signal and
it still looks bad, double check the <code class="docutils literal notranslate"><span class="pre">figures/registration/PREFIX</span></code> folder, look at the
<code class="docutils literal notranslate"><span class="pre">affine_debug_PREFIX...</span></code> png file. You might not have enough signal for affine
registration. If that’s the case, you will have to try similarity transform (not
supported anymore, but might still work).</p>
<ul class="simple">
<li><p>Are most shifts estimated correctly?</p></li>
</ul>
<p>Parameters you can tweak: <code class="docutils literal notranslate"><span class="pre">ops[&quot;ransac_max_shift&quot;]</span></code>, <code class="docutils literal notranslate"><span class="pre">ops[&quot;ransac_min_tiles&quot;]</span></code>, and
<code class="docutils literal notranslate"><span class="pre">ops[&quot;ransac_residual_threshold&quot;]</span></code>.</p>
</section>
</section>
<section id="registering-sequencing-rounds">
<h2>Registering sequencing rounds<a class="headerlink" href="#registering-sequencing-rounds" title="Link to this heading">¶</a></h2>
<p>We need to register the channels and rounds together and the tiles with their
neighbours.</p>
<section id="short-version">
<h3>Short version:<a class="headerlink" href="#short-version" title="Link to this heading">¶</a></h3>
<p>Final transforms for channel and round registration are saved in
<code class="docutils literal notranslate"><span class="pre">&quot;reg&quot;</span> <span class="pre">/</span> <span class="pre">f&quot;tforms_best_{prefix}_{roi}_{tilex}_{tiley}.npz&quot;</span></code>.
The second part must be run each time.</p>
</section>
</section>
<section id="detailed-explanation-part-1-estimating-angle-scale-and-shift">
<h2>Detailed explanation part 1: Estimating angle, scale and shift<a class="headerlink" href="#detailed-explanation-part-1-estimating-angle-scale-and-shift" title="Link to this heading">¶</a></h2>
<p>For each acquisition we need to find how the channels register together. It needs to be
done for each acquisition as the mirrors wobble a bit and the gain of the stage motor
seem to vary a bit.</p>
<section id="register-reference-tile">
<h3>Register reference tile<a class="headerlink" href="#register-reference-tile" title="Link to this heading">¶</a></h3>
<p>We do that on a manually tile that has signal with
<code class="docutils literal notranslate"><span class="pre">iss</span> <span class="pre">register-ref-tile</span></code>.</p>
<p>This will save <code class="docutils literal notranslate"><span class="pre">f&quot;tforms_{prefix}.npz&quot;</span></code> in the main <code class="docutils literal notranslate"><span class="pre">data_folder</span></code>. The npz contains:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">angles_within_channels</span></code>: rotation angles between rounds for each channel</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shifts_within_channels</span></code>: shifts between rounds for each channel</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scales_between_channels</span></code>: scaling between channels (common for all rounds)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">angles_between_channels</span></code>: rotation angles between channels (common for all rounds)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shifts_between_channels</span></code>: shifts between channels (common for all rounds)</p></li>
</ul>
<p>To estimate these values, the algorithm first align images for each channel across rounds.
This is much more reliable than registering different channels for the same acquisition, as
the sequencing dyes have limited bleedthrough across channels. On the other hand, when aligning
between rounds, many rolonies will have the same base and therefore show up across rounds,
providing a robust signal for registration.</p>
<p>Registration is done by iterative grid search. We first search over an initial range of rotation
angles and compute phase correlation for each angle. We then determine the best angle and narrow
the search range around this value. It is important that the initial spacing between angles is
fine enough that we can find this peak. This will yield <code class="docutils literal notranslate"><span class="pre">angles_within_channels</span></code> and
<code class="docutils literal notranslate"><span class="pre">shifts_within_channels</span></code>.</p>
<p>Once we have registered together rounds for each channel, we can use the resulting angles and
shifts to compute mean and STD projections across rounds (we use the STD projections because
rolonies show up very nicely on them). These projection should capture all rolonies and will
look very similar across channels. They are provide ideal signal for registration across channels.</p>
<p>To register channels we need to correct for scaling as well as rotation due to chromatic aberration
and small differences in alignment of the tube lenses for each camera. This is done using grid search,
similar to how <code class="docutils literal notranslate"><span class="pre">angles_within_channels</span></code> are estimated. We search for the best angles and scales
while iteratively refining the search range. This will yield <code class="docutils literal notranslate"><span class="pre">scales_between_channels</span></code>,
<code class="docutils literal notranslate"><span class="pre">angles_between_channels</span></code>, and <code class="docutils literal notranslate"><span class="pre">shifts_between_channels</span></code>.</p>
</section>
<section id="estimate-for-all-tiles">
<h3>Estimate for all tiles<a class="headerlink" href="#estimate-for-all-tiles" title="Link to this heading">¶</a></h3>
<p>We can then use the parameters estimated for the reference tile to register all tiles with:</p>
<p><code class="docutils literal notranslate"><span class="pre">iss</span> <span class="pre">estimate-shifts</span></code></p>
<p>This is necessary for two reasons. First, dichroic wobble slightly
during and between acquisitions resulting in different shifts between channels. Second, the
gain of the microscope stage seems to vary from day to day. Therefore, the microscope does not
consistently move to the same position for each tile from round to round, resulting in different
shifts across rounds. Therefore, we will re-estimate shifts, both within and across channel,
but will <strong>not</strong> change <code class="docutils literal notranslate"><span class="pre">angles_within_channels</span></code>, <code class="docutils literal notranslate"><span class="pre">angles_between_channels</span></code> and
<code class="docutils literal notranslate"><span class="pre">scales_between_channels</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">angles_within_channels</span></code> and <code class="docutils literal notranslate"><span class="pre">angles_between_channels</span></code> might actually vary due to the
dichroic wobble but in practice registration works well using values from the reference tile.</p>
</div>
<p>The output is saved in the <cite>reg</cite> subfolder as
<code class="docutils literal notranslate"><span class="pre">f&quot;tforms_{prefix}_{roi}_{tilex}_{tiley}.npz&quot;</span></code></p>
</section>
<section id="correct-shift-with-ransac">
<h3>Correct shift with ransac<a class="headerlink" href="#correct-shift-with-ransac" title="Link to this heading">¶</a></h3>
<p>The single tile estimation tends to fail sporadically if there is not enough signal. This
can be corrected given that the main change of shifts from tile to tile is a linear
function of X and Y (probably due to change in gain of the stage). We do that with
RANSAC robust regression in:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">iss</span> <span class="pre">correct-shifts</span></code>.</p>
</div></blockquote>
<p>Once again, this does <strong>not</strong> re-estimate angles and scale changes, just shifts. The
output is saved in the <code class="docutils literal notranslate"><span class="pre">reg</span></code> folder as
<code class="docutils literal notranslate"><span class="pre">f&quot;tforms_corrected_{prefix}_{roi}_{tilex}_{tiley}.npz&quot;</span></code></p>
<p>However, this correction is not ideal for tiles that were already properly registered
and can introduce bigger shifts. Therefore, we only apply this correction to tiles
that have a shift above a certain threshold. This threshold is currently set in
<code class="docutils literal notranslate"><span class="pre">ops['ransac_residual_threshold']</span></code></p>
<p>The final transformation is then saved in the <code class="docutils literal notranslate"><span class="pre">reg</span></code> folder as
<code class="docutils literal notranslate"><span class="pre">f&quot;tforms_best_{prefix}_{roi}_{tilex}_{tiley}.npz&quot;</span></code></p>
</section>
</section>
<section id="detailed-explanation-part-2-stitching-tiles">
<h2>Detailed explanation part 2: Stitching tiles<a class="headerlink" href="#detailed-explanation-part-2-stitching-tiles" title="Link to this heading">¶</a></h2>
<p>The information computed above allows us to load all tiles in their “acquisition”
coordinates (same for all tiles of one prefix, but different across prefixes).</p>
<section id="find-tile-shifts">
<h3>Find tile shifts<a class="headerlink" href="#find-tile-shifts" title="Link to this heading">¶</a></h3>
<p>We estimate how much overlap there is between tiles (and therefore how much we need
to shift them to merge) by phase correlation. This also takes into account that the
cameras may not be perfectly aligned with the stage, therefore there might be
(and usually will be) a shift in both X and Y between both rows and columns.</p>
<p>This is done by calling:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shift_right</span><span class="p">,</span> <span class="n">shift_down</span><span class="p">,</span> <span class="n">tile_shape</span> <span class="o">=</span> <span class="n">iss</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">register_adjacent_tiles</span><span class="p">(</span>
    <span class="n">data_path</span><span class="p">,</span> <span class="n">ref_coors</span><span class="o">=</span><span class="n">ops</span><span class="p">[</span><span class="s1">&#39;ref_tile&#39;</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;genes_round_1_1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The output is currently not saved.</p>
</section>
<section id="merge-coordinates">
<h3>Merge coordinates<a class="headerlink" href="#merge-coordinates" title="Link to this heading">¶</a></h3>
<p>With these tile shift we can find the position of each tile, simply by multiplying the
tile number by the shift.</p>
<p>This can be done with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">roi_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">processed_path</span> <span class="o">/</span> <span class="n">data_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_roi_dims.npy&quot;</span><span class="p">)</span>
<span class="n">ntiles</span> <span class="o">=</span> <span class="n">roi_dims</span><span class="p">[</span><span class="n">roi_dims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">tile_origins</span><span class="p">,</span> <span class="n">tile_centers</span> <span class="o">=</span> <span class="n">iss</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">calculate_tile_positions</span><span class="p">(</span>
        <span class="n">shift_right</span><span class="p">,</span> <span class="n">shift_down</span><span class="p">,</span> <span class="n">tile_shape</span><span class="p">,</span> <span class="n">ntiles</span><span class="p">)</span>
</pre></div>
</div>
<p>The output is currently not saved.</p>
</section>
</section>
<section id="registering-acquisition-together">
<h2>Registering acquisition together<a class="headerlink" href="#registering-acquisition-together" title="Link to this heading">¶</a></h2>
<p>The final reference coordinate is (for now) <code class="docutils literal notranslate"><span class="pre">genes_round</span></code>. We can register each
acquisition independently first. Then we want to merge them. To do that we generate
a downsampled stitched image of the reference acquisition and the acquisition we want
to register.</p>
<p>This is done for raw images with <code class="docutils literal notranslate"><span class="pre">iss.pipeline.stitch_and_register</span></code>. It returns the
two registered mosaic at full resolution as well as the transformation parameter: shift
and angle.</p>
<p>This output is not saved for now.</p>
<p>For spots, the same function is called by <code class="docutils literal notranslate"><span class="pre">iss-reg2ref</span> <span class="pre">align-spots</span></code></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="call.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Calling spots</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="project_and_average.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Crunch the data</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Znamenskiy lab
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Registration</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#register-sequencing-acquisitions">Register Sequencing acquisitions</a><ul>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#registering-sequencing-rounds">Registering sequencing rounds</a><ul>
<li><a class="reference internal" href="#short-version">Short version:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#detailed-explanation-part-1-estimating-angle-scale-and-shift">Detailed explanation part 1: Estimating angle, scale and shift</a><ul>
<li><a class="reference internal" href="#register-reference-tile">Register reference tile</a></li>
<li><a class="reference internal" href="#estimate-for-all-tiles">Estimate for all tiles</a></li>
<li><a class="reference internal" href="#correct-shift-with-ransac">Correct shift with ransac</a></li>
</ul>
</li>
<li><a class="reference internal" href="#detailed-explanation-part-2-stitching-tiles">Detailed explanation part 2: Stitching tiles</a><ul>
<li><a class="reference internal" href="#find-tile-shifts">Find tile shifts</a></li>
<li><a class="reference internal" href="#merge-coordinates">Merge coordinates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#registering-acquisition-together">Registering acquisition together</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=37f418d5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    </body>
</html>